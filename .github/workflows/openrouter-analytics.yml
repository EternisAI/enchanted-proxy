name: OpenRouter Daily Analytics to PostHog

on:
  schedule:
    # 45 minutes after midnight to get previous day's data
    - cron: '45 0 * * *'
  workflow_dispatch:
    inputs:
      date:
        description: 'Specific date to sync (YYYY-MM-DD)'
        required: false
        type: string
      start_date:
        description: 'Start date for range sync (YYYY-MM-DD)'
        required: false
        type: string
      end_date:
        description: 'End date for range sync (YYYY-MM-DD)'
        required: false
        type: string

env:
  OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_PROVISIONING_KEY }}
  POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
  POSTHOG_HOST: ${{ secrets.POSTHOG_HOST }}

jobs:
  fetch-and-send-analytics:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install requests
        
    - name: Sync OpenRouter analytics to PostHog
      run: |
        CMD="python scripts/sync_openrouter_analytics.py"
        
        if [ -n "${{ github.event.inputs.date }}" ]; then
          CMD="$CMD --date ${{ github.event.inputs.date }}"
        elif [ -n "${{ github.event.inputs.start_date }}" ]; then
          CMD="$CMD --start-date ${{ github.event.inputs.start_date }}"
          if [ -n "${{ github.event.inputs.end_date }}" ]; then
            CMD="$CMD --end-date ${{ github.event.inputs.end_date }}"
          fi
        fi
        
        echo "Running: $CMD"
        eval $CMD